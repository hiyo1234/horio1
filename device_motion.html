<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ジャイロの値を得る</title>
  </head>

  <body>

    <!-- データを表示するdiv要素 -->
    <button onClick="deviceMotionRequest()">Click</button>
    <button onclick="play_init()" id="play">最初に再生</button><br>
    <!-- <a href="javascript:void(0);" onclick="play_init();">再生</a><br/> -->
    <!-- 加速度データをリアルタイム表示 -->
    <div id="txt">ここにデータを表示</div><br>


    <!-- 加速度の閾値判定 -->
    <div id="acc_status">ここにデータを表示</div><br>
    <h4>正の加速度</h4>
    <meter max="10" low="1" high="4" optimum="0" id="plus">javascriptから参照</meter>
    <h4>負の加速度</h4>
    <meter max="10" low="1" high="4" optimum="0" id="minus">javascriptから参照</meter>

    <script>
      var all_info = 0;
      var x = 0,
        y = 0,
        z = 0;
      var now_acc_x = 0,
        now_acc_y = 0,
        now_acc_z = 0;
      //var threashold_x = 0, threashold_y = 0, threashold_z = 0;
      var acc_status;

      //音楽の読み込み
      var music = new Audio();

      function deviceMotionRequest() {
        if (navigator.userAgent.match(/iPhone/)) {
          if (DeviceMotionEvent.requestPermission) {
            DeviceMotionEvent.requestPermission().then((permissionState) => {
              if (permissionState === "granted") {
                window.addEventListener("devicemotion", motion);
              }
            });
          }
        } else {
          if (navigator.userAgent.match(/Android.+Mobile/)) {
            window.addEventListener("devicemotion", motion);
          }
        }
      }

      function motion() {

        all_info = event.accelerationIncludingGravity;
        x = all_info.x;
        y = all_info.y;
        z = all_info.z;

      }

      function play_init() {

        music.src = "tamborine.mp3";
        music.play();
      
      }

      // 指定時間ごとに繰り返し実行される setInterval(実行する内容, 間隔[ms]) タイマーを設定
      var timer = window.setInterval(() => {
        displayData(); // displayData 関数を実行
      }, 33); // 33msごとに（1秒間に約30回）

      //四捨五入関数
      function orgRound(value, base) {
        return Math.round(value * base) / base;
      }

      // データを表示する displayData 関数
      function displayData() {
        var txt = document.getElementById("txt"); // データを表示するdiv要素の取得

        txt.innerHTML =
          "x方向: " +
          orgRound(x, 10) +
          "<br>" + // x軸の値
          "y方向: " +
          orgRound(y, 10) +
          "<br>" + // y軸の値
          "z方向: " +
          orgRound(z, 10); // z軸の値

          //メータで表示
          if(y >= 0){

            if(y > 4) {
              music.currentTime = 0;
              music.play();  // 再生
            }
            meter_plus = document.getElementById("plus"); // データを表示するdiv要素の取得
            meter_plus.value = orgRound(y, 10);
            meter_minus = document.getElementById("minus"); // データを表示するdiv要素の取得
            meter_minus.value = 0;

          }
          else{
            if(y < -4) {
              music.currentTime = 0;
              music.play();  // 再生
            }
            meter_plus = document.getElementById("plus"); // データを表示するdiv要素の取得
            meter_plus.value = 0;
            meter_minus = document.getElementById("minus"); // データを表示するdiv要素の取得
            meter_minus.value = -orgRound(y, 10);

          }

          //閾値処理
          if(y >= -1 && y <= 1){

            acc_status = "status_stop";

          }
          else if(y >= -4 && y < -1){

            acc_status = "status_minuslow";

          }

          else if(y < -4){

            acc_status = "status_minushigh";

          }

          else if(y <= 4 && y > 1){

            acc_status = "status_pluslow";

          }

          else if(y > 4){

            acc_status = "status_plushigh";

          }

          var temp_status = document.getElementById("acc_status"); // データを表示するdiv要素の取得
          temp_status.innerHTML = acc_status;
        
        }

    </script>
  </body>
</html>
